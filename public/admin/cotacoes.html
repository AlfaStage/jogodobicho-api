<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cota√ß√µes | Admin</title>
    <link rel="stylesheet" href="/css/admin-theme.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>

<body>
    <main>
        <header class="page-header">
            <div class="page-title">
                <h1>Odds & Cota√ß√µes</h1>
                <p>Gerencie os multiplicadores de pr√™mios por modalidade.</p>
            </div>
            <div class="page-actions">
                <button onclick="syncCotacoes()" class="primary" id="btn-sync">
                    <i>ü¶Å</i> Sincronizar Agora
                </button>
            </div>
        </header>

        <div class="grid grid-2" id="cotacoes-grid">
            <!-- Injetado via JS -->
            <div class="card animate-pulse" style="height: 150px; background: #111;"></div>
            <div class="card animate-pulse" style="height: 150px; background: #111;"></div>
        </div>

        <section style="margin-top: 40px; border-top: 1px solid var(--border-main); padding-top: 30px;">
            <div class="card">
                <h3>Configura√ß√£o de Origem</h3>
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 20px;">
                    Os dados s√£o extra√≠dos automaticamente do site configurado no sistema.
                </p>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <input type="text" id="source-url" value="https://amigosdobicho.com/cotacoes" readonly
                        style="background: #080808; opacity: 0.7;">
                    <button class="secondary" onclick="UI.toast('URL definida via .env', 'info')">Ver Config</button>
                </div>
            </div>
        </section>
    </main>

    <script src="/admin/admin-common.js"></script>
    <script>
        async function loadCotacoes() {
            try {
                const response = await window.fetchAdmin('/v1/cotacao');
                const result = await response.json();

                const grid = document.getElementById('cotacoes-grid');
                if (result.data.length === 0) {
                    grid.innerHTML = '<div class="card" style="grid-column: span 2; text-align: center; padding: 60px;">Nenhuma cota√ß√£o encontrada.</div>';
                    return;
                }

                grid.innerHTML = result.data.map(item => `
                    <div class="card" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; font-weight: 700;">${item.modalidade}</span>
                            <h2 style="font-size: 1.8rem; margin: 5px 0 0;">${item.valor.split(' ')[1]}</h2>
                            <p style="color: var(--accent-green); font-size: 0.85rem; font-weight: 600;">${item.valor.split(' ')[0]} base</p>
                        </div>
                        <div style="text-align: right;">
                             <div style="font-size: 0.75rem; color: var(--text-muted);">√öltima atualiza√ß√£o</div>
                             <div style="font-size: 0.85rem;">${new Date(item.updated_at).toLocaleDateString('pt-BR')}</div>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                console.error(err);
                UI.toast('Erro ao carregar cota√ß√µes', 'error');
            }
        }

        async function syncCotacoes() {
            const btn = document.getElementById('btn-sync');
            const originalText = btn.innerHTML;

            btn.disabled = true;
            btn.innerHTML = '<i>‚è≥</i> Sincronizando...';
            UI.toast('Sincroniza√ß√£o iniciada. Isso pode levar alguns segundos...', 'info');

            try {
                const response = await window.fetchAdmin('/v1/cotacao/sync', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({}) });
                if (response.ok) {
                    UI.toast('Cota√ß√µes atualizadas com sucesso!');
                    loadCotacoes();
                } else {
                    throw new Error('Falha no server');
                }
            } catch (err) {
                UI.toast('Erro ao sincronizar cota√ß√µes', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        loadCotacoes();
    </script>
</body>

</html>