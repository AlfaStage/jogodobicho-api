<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Gerenciamento de Proxies - Screpy</title>
    <link rel="stylesheet" href="../css/admin-theme.css">
    <style>
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
        }

        .page-header p {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-top: 4px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            text-align: left;
            padding: 16px;
        }

        .stat-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .stat-value.green {
            color: var(--accent-green);
        }

        .stat-value.red {
            color: var(--accent-red);
        }

        .stat-value.blue {
            color: var(--accent-blue);
        }

        .stat-value.yellow {
            color: var(--accent-yellow);
        }

        .stat-sub {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            border-bottom: 1px solid var(--border-color);
            padding: 0 20px;
            margin-bottom: 0;
        }

        .tab-btn {
            background: transparent !important;
            color: var(--text-secondary) !important;
            border: none;
            padding: 12px 16px;
            border-radius: 0;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            box-shadow: none !important;
            transform: none !important;
        }

        .tab-btn:hover {
            color: var(--text-primary) !important;
            background: rgba(255, 255, 255, 0.03) !important;
            transform: none !important;
            box-shadow: none !important;
        }

        .tab-btn.active {
            color: var(--accent-green) !important;
            border-bottom-color: var(--accent-green);
        }

        .tab-panel {
            display: none;
            padding: 20px;
        }

        .tab-panel.active {
            display: block;
        }

        /* Proxy Table */
        .proxy-table {
            width: 100%;
            border-collapse: collapse;
        }

        .proxy-table th {
            text-align: left;
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .proxy-table td {
            padding: 10px 12px;
            font-size: 0.85rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            vertical-align: middle;
        }

        .proxy-table tr:hover td {
            background: var(--bg-hover);
        }

        .proxy-host {
            font-family: var(--font-mono);
            font-weight: 600;
            font-size: 0.8rem;
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .badge-alive {
            background: rgba(34, 197, 94, 0.15);
            color: var(--accent-green);
        }

        .badge-dead {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
        }

        .badge-untested {
            background: rgba(136, 136, 136, 0.15);
            color: var(--text-secondary);
        }

        .badge-protocol {
            background: rgba(59, 130, 246, 0.15);
            color: var(--accent-blue);
        }

        .badge-source {
            background: rgba(136, 136, 136, 0.1);
            color: var(--text-secondary);
        }

        /* Toggle */
        .toggle {
            width: 34px;
            height: 18px;
            border-radius: 9px;
            background: #333;
            position: relative;
            cursor: pointer;
            transition: background 0.3s;
            display: inline-block;
        }

        .toggle.active {
            background: var(--accent-green);
        }

        .toggle::after {
            content: '';
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: white;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }

        .toggle.active::after {
            transform: translateX(16px);
        }

        /* Latency bar */
        .latency-bar {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
        }

        .latency-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .latency-good {
            background: var(--accent-green);
        }

        .latency-ok {
            background: var(--accent-yellow);
        }

        .latency-bad {
            background: var(--accent-red);
        }

        /* Source breakdown */
        .source-grid {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .source-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            font-size: 0.8rem;
        }

        .source-chip .count {
            font-weight: 700;
            color: var(--accent-green);
        }

        /* Error text */
        .error-text {
            color: var(--accent-red);
            font-size: 0.7rem;
            max-width: 180px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Bulk form */
        .form-card {
            padding: 24px;
        }

        .form-card textarea {
            min-height: 140px;
            font-family: var(--font-mono);
            font-size: 0.8rem;
            line-height: 1.4;
        }

        .formats-list {
            display: flex;
            gap: 12px;
            margin: 12px 0;
            flex-wrap: wrap;
        }

        .format-tag {
            background: var(--bg-primary);
            padding: 4px 10px;
            border-radius: 4px;
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: var(--accent-green);
        }

        .bulk-result {
            display: none;
            margin-top: 16px;
            padding: 12px;
            border-radius: 8px;
            background: var(--bg-primary);
        }

        /* Progress indicator */
        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            height: 3px;
            background: var(--accent-green);
            transition: width 0.3s;
            z-index: 200;
            box-shadow: 0 0 10px var(--accent-green);
            display: none;
        }

        .progress-bar.active {
            display: block;
            animation: progressPulse 1.5s ease infinite;
        }

        @keyframes progressPulse {
            0% {
                width: 10%;
            }

            50% {
                width: 70%;
            }

            100% {
                width: 95%;
            }
        }

        /* Score bar */
        .score-bar {
            width: 50px;
            height: 6px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
            display: inline-block;
            vertical-align: middle;
            margin-right: 4px;
        }

        .score-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.3s;
        }

        /* Action buttons */
        .btn-icon {
            width: 30px;
            height: 30px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 0.8rem;
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: none !important;
            transform: none !important;
        }

        .btn-icon:hover {
            background: var(--bg-hover);
            border-color: rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
            transform: none !important;
            box-shadow: none !important;
        }

        .btn-icon.danger:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: var(--accent-red);
            color: var(--accent-red);
        }
    </style>
</head>

<body>
    <div class="progress-bar" id="progressBar"></div>

    <header>
        <div style="display: flex; align-items: center; gap: 20px;">
            <h1>Jogo do Bicho</h1>
            <nav class="nav">
                <a href="/admin/status" id="linkStatus">Status</a>
                <a href="/admin/webhooks" id="linkWebhooks">Webhooks</a>
                <a href="/admin/template" id="linkTemplate">Template</a>
                <a href="/admin/proxies-page" id="linkProxies" class="active">Proxies</a>
                <a href="/docs" id="linkDocs">API Docs</a>
            </nav>
        </div>
    </header>

    <main>
        <!-- Page Header -->
        <div class="page-header">
            <div>
                <h2 style="margin-bottom: 0;">üõ°Ô∏è Gerenciamento de Proxies</h2>
                <p>Coleta autom√°tica de 4 fontes gratuitas ‚Ä¢ Valida√ß√£o TCP a cada minuto ‚Ä¢ Proxy usado apenas como
                    fallback</p>
            </div>
            <div class="header-actions">
                <button class="secondary" onclick="triggerCollect()" id="btnCollect">üîÑ Coletar Agora</button>
                <button class="secondary" onclick="triggerTest()" id="btnTest">üß™ Testar Todos</button>
                <button onclick="loadData()">üìä Atualizar</button>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid" id="statsGrid">
            <div class="card stat-card">
                <div class="stat-label">üì¶ Total</div>
                <div class="stat-value blue" id="statTotal">0</div>
            </div>
            <div class="card stat-card">
                <div class="stat-label">üü¢ Vivos</div>
                <div class="stat-value green" id="statAlive">0</div>
            </div>
            <div class="card stat-card">
                <div class="stat-label">üî¥ Mortos</div>
                <div class="stat-value red" id="statDead">0</div>
            </div>
            <div class="card stat-card">
                <div class="stat-label">‚úÖ Habilitados</div>
                <div class="stat-value green" id="statEnabled">0</div>
            </div>
            <div class="card stat-card">
                <div class="stat-label">üéØ Taxa de Sucesso</div>
                <div class="stat-value yellow" id="statRate">0%</div>
                <div class="stat-sub" id="statRateDetail">0 / 0</div>
            </div>
            <div class="card stat-card">
                <div class="stat-label">‚õî Blacklistados</div>
                <div class="stat-value red" id="statBlacklist">0</div>
            </div>
        </div>

        <!-- Source breakdown -->
        <div class="source-grid" id="sourceGrid"></div>

        <!-- Main card with tabs -->
        <div class="card" style="margin-top: 24px; overflow: visible;">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('list', this)">üìã Lista de Proxies</button>
                <button class="tab-btn" onclick="switchTab('import', this)">üì§ Importar</button>
            </div>

            <!-- Tab: List -->
            <div class="tab-panel active" id="tab-list">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <span style="font-size: 0.8rem; color: var(--text-secondary);" id="proxyCount">0 proxies</span>
                    <div style="display: flex; gap: 8px;">
                        <button class="secondary" onclick="clearDead()"
                            style="font-size: 0.75rem; padding: 4px 10px;">üóëÔ∏è Limpar Mortos</button>
                        <button class="secondary" onclick="resetStats()"
                            style="font-size: 0.75rem; padding: 4px 10px;">üìä Resetar Stats</button>
                        <button class="secondary" onclick="clearBlacklist()"
                            style="font-size: 0.75rem; padding: 4px 10px;">üîì Limpar Blacklist</button>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table class="proxy-table">
                        <thead>
                            <tr>
                                <th>ON</th>
                                <th>Status</th>
                                <th>Proxy</th>
                                <th>Proto</th>
                                <th>Fonte</th>
                                <th>Lat√™ncia</th>
                                <th>Score</th>
                                <th>Sucesso</th>
                                <th>Erros</th>
                                <th>√öltimo Teste</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="proxyList">
                            <tr>
                                <td colspan="11">
                                    <div class="empty-state" style="padding: 40px;">Carregando...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab: Import -->
            <div class="tab-panel" id="tab-import">
                <div class="form-card">
                    <h3>üì§ Importar Proxies Manualmente</h3>
                    <p style="color: var(--text-secondary); font-size: 0.8rem; margin: 8px 0;">
                        Cole a lista de proxies, um por linha. Formatos aceitos:
                    </p>
                    <div class="formats-list">
                        <span class="format-tag">http://user:pass@host:port</span>
                        <span class="format-tag">host:port:user:pass</span>
                        <span class="format-tag">host:port</span>
                    </div>
                    <form onsubmit="bulkImport(event)">
                        <textarea id="bulkText" placeholder="proxy1.example.com:8080
proxy2.example.com:8080:user:pass
http://user:pass@proxy3.example.com:3128
# Linhas com # s√£o ignoradas"></textarea>
                        <div style="margin-top: 12px; display: flex; gap: 8px;">
                            <button type="submit">Importar Proxies</button>
                        </div>
                    </form>
                    <div class="bulk-result" id="bulkResult"></div>
                </div>
            </div>
        </div>

        <!-- Timestamps -->
        <div style="margin-top: 16px; display: flex; gap: 24px; color: var(--text-secondary); font-size: 0.75rem;">
            <span>√öltima coleta: <strong id="tsCollect">‚Äî</strong></span>
            <span>√öltimo teste: <strong id="tsTest">‚Äî</strong></span>
        </div>
    </main>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const apiKey = urlParams.get('key') || '';

        // Update nav links
        if (apiKey) {
            document.querySelectorAll('.nav a').forEach(a => {
                if (!a.href.includes('/docs')) {
                    const url = new URL(a.href);
                    url.searchParams.set('key', apiKey);
                    a.href = url.toString();
                }
            });
        }

        async function apiFetch(path, opts = {}) {
            const sep = path.includes('?') ? '&' : '?';
            const url = apiKey ? `${path}${sep}key=${apiKey}` : path;
            return fetch(url, {
                ...opts,
                headers: { 'Content-Type': 'application/json', ...opts.headers }
            }).then(r => r.json());
        }

        function showProgress(show) {
            document.getElementById('progressBar').classList.toggle('active', show);
        }

        function showToast(msg, type = 'success') {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.borderLeft = `3px solid ${type === 'success' ? 'var(--accent-green)' : 'var(--accent-red)'}`;
            toast.innerHTML = `<span>${type === 'success' ? '‚úÖ' : '‚ùå'}</span><span>${msg}</span>`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3500);
        }

        function switchTab(tab, btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
        }

        function fmtDate(d) {
            if (!d) return '‚Äî';
            return new Date(d).toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        function getScoreColor(score) {
            if (score >= 70) return 'var(--accent-green)';
            if (score >= 40) return 'var(--accent-yellow)';
            return 'var(--accent-red)';
        }

        function getLatencyClass(ms) {
            if (!ms) return 'latency-bad';
            if (ms <= 500) return 'latency-good';
            if (ms <= 1200) return 'latency-ok';
            return 'latency-bad';
        }

        async function loadData() {
            try {
                const data = await apiFetch('/admin/proxies/list');
                updateStats(data.stats);
                renderList(data.proxies);
            } catch (err) {
                console.error(err);
                showToast('Erro ao carregar dados', 'error');
            }
        }

        function updateStats(s) {
            document.getElementById('statTotal').textContent = s.total;
            document.getElementById('statAlive').textContent = s.alive;
            document.getElementById('statDead').textContent = s.dead;
            document.getElementById('statEnabled').textContent = s.enabled;
            document.getElementById('statBlacklist').textContent = s.blacklisted;

            const total = s.total_success + s.total_errors;
            const rate = total > 0 ? ((s.total_success / total) * 100).toFixed(1) : '0';
            document.getElementById('statRate').textContent = `${rate}%`;
            document.getElementById('statRateDetail').textContent = `${s.total_success} ‚úì / ${s.total_errors} ‚úó`;

            document.getElementById('tsCollect').textContent = fmtDate(s.lastCollectedAt);
            document.getElementById('tsTest').textContent = fmtDate(s.lastTestedAt);

            // Source breakdown
            const sourceGrid = document.getElementById('sourceGrid');
            sourceGrid.innerHTML = Object.entries(s.bySource || {})
                .map(([src, count]) => `<div class="source-chip"><span>${src}</span><span class="count">${count}</span></div>`)
                .join('');

            // Add protocol chips
            const protocolChips = Object.entries(s.byProtocol || {})
                .map(([proto, count]) => `<div class="source-chip"><span>${proto.toUpperCase()}</span><span class="count">${count}</span></div>`)
                .join('');
            sourceGrid.innerHTML += protocolChips;
        }

        function renderList(proxies) {
            const tbody = document.getElementById('proxyList');
            document.getElementById('proxyCount').textContent = `${proxies.length} proxies`;

            if (proxies.length === 0) {
                tbody.innerHTML = `<tr><td colspan="11"><div class="empty-state" style="padding: 40px;"><p>Nenhum proxy cadastrado. Clique em "üîÑ Coletar Agora" para buscar proxies automaticamente.</p></div></td></tr>`;
                return;
            }

            tbody.innerHTML = proxies.map(p => {
                const statusBadge = p.last_tested_at
                    ? (p.alive ? '<span class="badge badge-alive">‚óè Vivo</span>' : '<span class="badge badge-dead">‚óè Morto</span>')
                    : '<span class="badge badge-untested">‚óè N/T</span>';

                const scoreColor = getScoreColor(p.score);
                const latencyClass = getLatencyClass(p.latency_ms);

                return `<tr>
                    <td><div class="toggle ${p.enabled ? 'active' : ''}" onclick="toggleProxy('${p.id}')" title="${p.enabled ? 'Habilitado' : 'Desabilitado'}"></div></td>
                    <td>${statusBadge}</td>
                    <td class="proxy-host">${p.host}:${p.port}</td>
                    <td><span class="badge badge-protocol">${p.protocol.toUpperCase()}</span></td>
                    <td><span class="badge badge-source">${p.source || 'Manual'}</span></td>
                    <td>
                        <div class="latency-bar">
                            <span class="latency-dot ${latencyClass}"></span>
                            <span>${p.latency_ms ? p.latency_ms + 'ms' : '‚Äî'}</span>
                        </div>
                    </td>
                    <td>
                        <div class="score-bar"><div class="score-fill" style="width: ${p.score}%; background: ${scoreColor};"></div></div>
                        <span style="font-size: 0.75rem; color: ${scoreColor};">${p.score}</span>
                    </td>
                    <td><span style="color: var(--accent-green); font-size: 0.8rem;">${p.success_count}</span></td>
                    <td>
                        <span style="color: var(--accent-red); font-size: 0.8rem;">${p.error_count}</span>
                        ${p.last_error ? `<div class="error-text" title="${p.last_error}">${p.last_error}</div>` : ''}
                    </td>
                    <td style="font-size: 0.75rem; color: var(--text-secondary);">${fmtDate(p.last_tested_at)}</td>
                    <td><button class="btn-icon danger" onclick="removeProxy('${p.id}')" title="Remover">üóëÔ∏è</button></td>
                </tr>`;
            }).join('');
        }

        async function triggerCollect() {
            const btn = document.getElementById('btnCollect');
            btn.disabled = true;
            btn.textContent = '‚è≥ Coletando...';
            showProgress(true);

            try {
                const data = await apiFetch('/admin/proxies/collect', { method: 'POST' });
                showToast(`Coleta finalizada: ${data.total} encontrados, ${data.added} novos`);
                loadData();
            } catch (err) {
                showToast('Erro na coleta', 'error');
            } finally {
                showProgress(false);
                btn.disabled = false;
                btn.textContent = 'üîÑ Coletar Agora';
            }
        }

        async function triggerTest() {
            const btn = document.getElementById('btnTest');
            btn.disabled = true;
            btn.textContent = '‚è≥ Testando...';
            showProgress(true);

            try {
                const data = await apiFetch('/admin/proxies/test-all', { method: 'POST' });
                showToast(`Teste finalizado: ${data.alive} vivos, ${data.dead} mortos`);
                loadData();
            } catch (err) {
                showToast('Erro nos testes', 'error');
            } finally {
                showProgress(false);
                btn.disabled = false;
                btn.textContent = 'üß™ Testar Todos';
            }
        }

        async function toggleProxy(id) {
            try {
                await apiFetch(`/admin/proxies/${id}/toggle`, { method: 'POST' });
                loadData();
            } catch (err) {
                showToast('Erro ao alternar proxy', 'error');
            }
        }

        async function removeProxy(id) {
            if (!confirm('Remover este proxy?')) return;
            try {
                await apiFetch(`/admin/proxies/${id}`, { method: 'DELETE' });
                showToast('Proxy removido');
                loadData();
            } catch (err) {
                showToast('Erro ao remover', 'error');
            }
        }

        async function clearDead() {
            if (!confirm('Remover todos os proxies mortos?')) return;
            try {
                const data = await apiFetch('/admin/proxies/clear-dead', { method: 'POST' });
                showToast(`${data.removed} proxies mortos removidos`);
                loadData();
            } catch (err) {
                showToast('Erro', 'error');
            }
        }

        async function resetStats() {
            if (!confirm('Resetar todas as estat√≠sticas?')) return;
            try {
                await apiFetch('/admin/proxies/reset-stats', { method: 'POST' });
                showToast('Estat√≠sticas resetadas');
                loadData();
            } catch (err) {
                showToast('Erro', 'error');
            }
        }

        async function clearBlacklist() {
            try {
                await apiFetch('/admin/proxies/clear-blacklist', { method: 'POST' });
                showToast('Blacklist limpa');
                loadData();
            } catch (err) {
                showToast('Erro', 'error');
            }
        }

        async function bulkImport(e) {
            e.preventDefault();
            const text = document.getElementById('bulkText').value;
            if (!text.trim()) return showToast('Cole a lista de proxies', 'error');

            try {
                const data = await apiFetch('/admin/proxies/bulk', { method: 'POST', body: JSON.stringify({ text }) });
                const resultDiv = document.getElementById('bulkResult');
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `
                    <div style="display: flex; gap: 12px; margin-bottom: 8px;">
                        <span class="badge badge-alive">‚úÖ ${data.added} adicionados</span>
                        <span class="badge badge-untested">‚è≠Ô∏è ${data.skipped} duplicados</span>
                        ${data.errors?.length ? `<span class="badge badge-dead">‚ùå ${data.errors.length} erros</span>` : ''}
                    </div>
                    ${data.errors?.length ? `<div style="color: var(--accent-red); font-size: 0.75rem; margin-top: 8px;">${data.errors.join('<br>')}</div>` : ''}
                `;

                if (data.added > 0) {
                    showToast(`${data.added} proxies importados!`);
                    document.getElementById('bulkText').value = '';
                    loadData();
                }
            } catch (err) {
                showToast('Erro na importa√ß√£o', 'error');
            }
        }

        // Auto-refresh every 60 seconds
        setInterval(loadData, 60000);

        // Initial load
        loadData();
    </script>
</body>

</html>