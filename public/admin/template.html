<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Designer de Template</title>
    <link rel="stylesheet" href="../css/admin-theme.css">
    <link rel="stylesheet" href="admin-common.css">
    <script src="admin-common.js"></script>
    <style>
        /* Ajustes espec√≠ficos para o Editor */
        .editor-container {
            display: flex;
            flex: 1;
            gap: 20px;
            padding: 20px;
            height: calc(100vh - 80px);
            /* Ajuste para caber com header */
            box-sizing: border-box;
        }

        .pane {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        textarea {
            flex: 1;
            background: #111;
            color: #d4d4d4;
            border: none;
            padding: 20px;
            font-family: var(--font-mono);
            font-size: 14px;
            resize: none;
            line-height: 1.6;
        }

        .preview-content {
            flex: 1;
            padding: 40px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            overflow-y: auto;
            background: #0a0a0a;
            /* Fundo levemente mais escuro para contraste */
        }

        /* Container do iframe com scale para manter visual 350px */
        .iframe-container {
            width: 350px;
            height: 600px;
            overflow: hidden;
        }

        iframe {
            border: none;
            width: 700px;
            height: 1200px;
            background: transparent;
            transform: scale(0.5);
            transform-origin: top left;
        }

        img {
            margin-top: 30px;
            width: 350px;
            height: auto;
            border: none;
            transition: all 0.3s ease;
        }

        .status-badge {
            margin-right: 15px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
    </style>
</head>

<body>
    <div class="editor-container" style="display: flex; flex-direction: column;">
        <div
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 10px 0; border-bottom: 1px solid var(--border-color);">
            <h2 style="margin: 0;">üé® Designer de Template</h2>
            <div style="display: flex; align-items: center; gap: 10px;">
                <span id="status" class="status-badge"></span>
                <button class="secondary" onclick="updatePreview()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 4v6h-6" />
                        <path d="M1 20v-6h6" />
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />
                    </svg>
                    Preview
                </button>
                <button onclick="saveTemplate()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
                        <polyline points="17 21 17 13 7 13 7 21" />
                        <polyline points="7 3 7 8 15 8" />
                    </svg>
                    Salvar
                </button>
            </div>
        </div>
        <div style="display: flex; flex: 1; gap: 20px;">
            <div class="pane-header">
                <span>HTML (Edit√°vel)</span>
                <span style="font-size: 0.8em; opacity: 0.7;">Vari√°veis: {{DATA}}, {{PREMIOS}}, {{LOTERICA}}</span>
            </div>
            <textarea id="codeEditor" spellcheck="false" placeholder="<!-- Digite seu HTML aqui -->"></textarea>
        </div>

        <div class="pane">
            <div class="pane-header">Visualiza√ß√£o Real</div>
            <div class="preview-content">
                <!-- Iframe para ver o HTML real -->
                <div
                    style="width: 100%; display: flex; justify-content: space-between; margin-bottom: 10px; color: #666; font-size: 0.8em;">
                    <span>WEB PREVIEW (350px exibi√ß√£o)</span>
                </div>
                <div class="iframe-container">
                    <iframe id="iframePreview"></iframe>
                </div>

                <!-- Imagem gerada pelo backend (Satori) -->
                <div
                    style="width: 100%; display: flex; justify-content: space-between; margin-top: 30px; margin-bottom: 10px; color: #666; font-size: 0.8em;">
                    <span>IMAGE GENERATION (PNG 700px - 2x resolu√ß√£o)</span>
                </div>
                <img id="imagePreview" alt="Aguardando preview..." />
            </div>
        </div>
    </div>

    <script>
        const EDITOR = document.getElementById('codeEditor');
        const IFRAME = document.getElementById('iframePreview');
        const IMG = document.getElementById('imagePreview');
        const STATUS = document.getElementById('status');

        // Template padr√£o com CSS inline e linha de pr√™mio customiz√°vel
        const DEFAULT_TEMPLATE = `<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Resultado {{LOTERICA}} - {{HORARIO}}</title>
</head>
<body style="margin: 0; padding: 0; background-color: transparent; display: flex; justify-content: center; align-items: flex-start; font-family: 'Inter', sans-serif;">
    <div style="display: flex; flex-direction: column; width: 700px; background-color: #ffffff; overflow: hidden; box-sizing: border-box;">
        <!-- T√≠tulo - CUSTOMIZE cores, fontes, etc -->
        <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; font-weight: 700; padding: 20px 0; background-color: #f8f9fa; font-size: 52px; color: #1a1a1a; border-bottom: 2px solid #eeeeee; width: 700px; box-sizing: border-box;">
            {{LOTERICA}}
        </div>
        <!-- Subt√≠tulo -->
        <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; font-weight: 700; padding: 20px 0; background-color: #f8f9fa; font-size: 36px; color: #1a1a1a; border-bottom: 2px solid #eeeeee; width: 700px; box-sizing: border-box;">
            {{DATA}} - {{HORARIO}}
        </div>
        <!-- Tabela -->
        <div style="display: flex; flex-direction: column; width: 700px; box-sizing: border-box;">
            <!-- Cabe√ßalho -->
            <div style="display: flex; flex-direction: row; width: 700px; background-color: #222222; box-sizing: border-box;">
                <div style="display: flex; width: 140px; padding: 28px 8px; justify-content: center; align-items: center; text-align: center; font-weight: 700; font-size: 28px; color: #ffffff; text-transform: uppercase; box-sizing: border-box;">Pr√™mio</div>
                <div style="display: flex; width: 220px; padding: 28px 8px; justify-content: center; align-items: center; text-align: center; font-weight: 700; font-size: 28px; color: #ffffff; text-transform: uppercase; box-sizing: border-box;">Milhar</div>
                <div style="display: flex; width: 120px; padding: 28px 8px; justify-content: center; align-items: center; text-align: center; font-weight: 700; font-size: 28px; color: #ffffff; text-transform: uppercase; box-sizing: border-box;">Grupo</div>
                <div style="display: flex; width: 220px; padding: 28px 8px; justify-content: center; align-items: center; text-align: center; font-weight: 700; font-size: 28px; color: #ffffff; text-transform: uppercase; box-sizing: border-box;">Animal</div>
            </div>
            <!-- Corpo -->
            <div style="display: flex; flex-direction: column; width: 700px; box-sizing: border-box;">
                {{PREMIOS}}
            </div>
        </div>
    </div>
</body>
</html>

<!-- ============================================================
     TEMPLATE DE LINHA DE PR√äMIO - CUSTOMIZE TOTALMENTE!
     ============================================================
     Este bloco ser√° REPETIDO para cada pr√™mio.
     Vari√°veis: {{POSICAO}}, {{MILHAR}}, {{GRUPO}}, {{BICHO}}
     NOTA: Valores em 2x para alta resolu√ß√£o (700px base)
     ============================================================ -->
<!-- PREMIO_ROW -->
<div style="display: flex; flex-direction: row; width: 700px; background-color: #ffffff; border-bottom: 2px solid #eeeeee; box-sizing: border-box;">
    <div style="display: flex; width: 140px; padding: 28px 8px; justify-content: center; align-items: center; text-align: center; font-size: 32px; color: #666666; box-sizing: border-box;">{{POSICAO}}¬∫</div>
    <div style="display: flex; width: 220px; padding: 28px 8px; justify-content: center; align-items: center; text-align: center; font-weight: bold; font-size: 36px; color: #000000; box-sizing: border-box;">{{MILHAR}}</div>
    <div style="display: flex; width: 120px; padding: 28px 8px; justify-content: center; align-items: center; text-align: center; font-size: 32px; color: #666666; box-sizing: border-box;">{{GRUPO}}</div>
    <div style="display: flex; width: 220px; padding: 28px 8px; justify-content: center; align-items: center; text-align: center; font-size: 32px; color: #444444; box-sizing: border-box;">{{BICHO}}</div>
</div>
<!-- /PREMIO_ROW -->`;


        // Persist√™ncia da API Key na URL
        const fetchWithKey = window.fetchAdmin;

        // Validar se o HTML usa apenas CSS inline
        function validateInlineCSS(html) {
            // Verifica se h√° tags <style> ou <link> de CSS
            const hasStyleTag = /<style[\s\S]*?>[\s\S]*?<\/style>/gi.test(html);
            const hasLinkCSS = /<link[^>]+rel=["']stylesheet["'][^>]*>/gi.test(html);

            if (hasStyleTag) {
                return { valid: false, message: 'Erro: Use apenas CSS inline (style="..."). Tags <style> n√£o s√£o permitidas.' };
            }
            if (hasLinkCSS) {
                return { valid: false, message: 'Erro: Use apenas CSS inline (style="..."). Links de CSS externos n√£o s√£o permitidos.' };
            }
            return { valid: true };
        }

        // Carregar template atual
        async function loadTemplate() {
            try {
                const res = await fetchWithKey('/admin/api/template');
                if (res.ok) {
                    const data = await res.json();
                    EDITOR.value = data.html || DEFAULT_TEMPLATE;
                } else {
                    EDITOR.value = DEFAULT_TEMPLATE;
                }
                updatePreview();
            } catch (e) {
                console.error("Falha ao carregar", e);
                EDITOR.value = DEFAULT_TEMPLATE;
            }
        }

        // Gerar preview
        async function updatePreview() {
            const html = EDITOR.value;
            if (!html) return;

            // Validar CSS inline
            const validation = validateInlineCSS(html);
            if (!validation.valid) {
                STATUS.innerText = validation.message;
                STATUS.style.color = '#ff5252';
                return;
            }
            STATUS.style.color = '';

            STATUS.innerText = 'Gerando...';

            try {
                const res = await fetchWithKey('/admin/api/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ html })
                });

                if (!res.ok) throw new Error("Erro na API");

                const data = await res.json();

                // Atualizar Iframe
                const iframeDoc = IFRAME.contentWindow.document;
                iframeDoc.open();
                iframeDoc.write(data.html);
                iframeDoc.close();

                // Atualizar Imagem
                IMG.src = data.image;
                STATUS.innerText = 'Atualizado!';
                setTimeout(() => STATUS.innerText = '', 2000);
            } catch (e) {
                console.error(e);
                STATUS.innerText = 'Erro no preview.';
            }
        }

        // Salvar
        async function saveTemplate() {
            const html = EDITOR.value;

            // Validar CSS inline antes de salvar
            const validation = validateInlineCSS(html);
            if (!validation.valid) {
                STATUS.innerText = validation.message;
                STATUS.style.color = '#ff5252';
                return;
            }
            STATUS.style.color = '';

            STATUS.innerText = 'Salvando...';

            try {
                const res = await fetchWithKey('/admin/api/template', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ html })
                });

                if (res.ok) {
                    STATUS.innerText = 'Salvo com sucesso!';
                    setTimeout(() => STATUS.innerText = '', 2000);
                } else {
                    STATUS.innerText = 'Erro ao salvar.';
                }
            } catch (e) {
                console.error(e);
                STATUS.innerText = 'Erro de conex√£o.';
            }
        }

        // Auto-update com debounce
        let timeout;
        EDITOR.addEventListener('input', () => {
            clearTimeout(timeout);
            timeout = setTimeout(updatePreview, 1000);
        });

        loadTemplate();
    </script>
</body>

</html>